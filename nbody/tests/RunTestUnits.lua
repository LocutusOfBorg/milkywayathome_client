
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
local testSeed = testSeeds[1]
--local testSeed = testSeeds[5]


refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 3562.617707901308,
         ["886885833"] = 3565.6812810464794,
         ["715144259"] = 3570.8203569489588,
         ["430281807"] = 3559.466910861605,
         ["543966758"] = 3565.7827041320134
      },

      ["1024"] = {
         ["670828913"] = 3482.2230379821167,
         ["886885833"] = 3464.915180503,
         ["715144259"] = 3470.136111625581,
         ["430281807"] = 3479.469561774677,
         ["543966758"] = 3475.0210870302876
      },

      ["10000"] = {
         ["670828913"] = 3461.8834064667867,
         ["886885833"] = 3411.1645537343184,
         ["715144259"] = 3430.7246126351006,
         ["430281807"] = 3415.899853511762,
         ["543966758"] = 3437.8922866892117
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 3583.1483855268034,
         ["886885833"] = 3583.711521222924,
         ["715144259"] = 3576.20894759335,
         ["430281807"] = 3588.416637908917,
         ["543966758"] = 3592.087894468842
      },

      ["1024"] = {
         ["670828913"] = 3527.5010676373367,
         ["886885833"] = 3539.388418439747,
         ["715144259"] = 3535.854361713284,
         ["430281807"] = 3524.1609143770684,
         ["543966758"] = 3535.9792834182226
      },

      ["10000"] = {
         ["670828913"] = 3513.1562109183465,
         ["886885833"] = 3516.9640277210883,
         ["715144259"] = 3524.0262254083023,
         ["430281807"] = 3507.248231052449,
         ["543966758"] = 3505.3349087971233
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 3595.2354802098803,
         ["886885833"] = 3594.1413144711687,
         ["715144259"] = 3587.301615131664,
         ["430281807"] = 3598.979211765489,
         ["543966758"] = 3607.8021232280926
      },

      ["1024"] = {
         ["670828913"] = 3531.381792048837,
         ["886885833"] = 3538.360790882986,
         ["715144259"] = 3538.3571361903923,
         ["430281807"] = 3524.8846794513906,
         ["543966758"] = 3537.919536047855
      },

      ["10000"] = {
         ["670828913"] = 3519.7980581632573,
         ["886885833"] = 3511.3715344786942,
         ["715144259"] = 3514.6626122914986,
         ["430281807"] = 3502.6389253075067,
         ["543966758"] = 3517.7042542336794
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 3795.322636633471,
         ["886885833"] = 3764.129024733756,
         ["715144259"] = 3748.4204815443977,
         ["430281807"] = 3736.9615969803385,
         ["543966758"] = 3753.546097630659
      },

      ["1024"] = {
         ["670828913"] = 3486.383157809933,
         ["886885833"] = 3500.3587644166128,
         ["715144259"] = 3547.3580937768775,
         ["430281807"] = 3482.3369724004847,
         ["543966758"] = 3502.246379502874
      },

      ["10000"] = {
         ["670828913"] = 3432.421774211373,
         ["886885833"] = 3430.969910670374,
         ["715144259"] = 3416.9155659898,
         ["430281807"] = 3412.0671341965676,
         ["543966758"] = 3479.2799518400507
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 3665.8498140755355,
         ["886885833"] = 3648.2332620609436,
         ["715144259"] = 3615.5047146375787,
         ["430281807"] = 3643.0897699656393,
         ["543966758"] = 3629.3371565151006
      },

      ["1024"] = {
         ["670828913"] = 3403.9177609158182,
         ["886885833"] = 3413.3264868464307,
         ["715144259"] = 3431.121073557535,
         ["430281807"] = 3534.1277942668335,
         ["543966758"] = 3400.433722730635
      },

      ["10000"] = {
         ["670828913"] = 3399.271922922414,
         ["886885833"] = 3419.7549945383453,
         ["715144259"] = 3403.187833789114,
         ["430281807"] = 3395.756289428849,
         ["543966758"] = 3401.6457266540438
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 3629.796077429534,
         ["886885833"] = 3642.9055909846425,
         ["715144259"] = 3622.667266629288,
         ["430281807"] = 3683.509470410657,
         ["543966758"] = 3645.0077711891504
      },

      ["1024"] = {
         ["670828913"] = 3520.877180324682,
         ["886885833"] = 3554.602008822562,
         ["715144259"] = 3657.865393775797,
         ["430281807"] = 3583.1220172824387,
         ["543966758"] = 3599.4491262856554
      },

      ["10000"] = {
         ["670828913"] = 3570.023084831629,
         ["886885833"] = 3644.629480157784,
         ["715144259"] = 3567.5448648369197,
         ["430281807"] = 3598.192975461241,
         ["543966758"] = 3580.812628768418
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 3798.075947072967,
         ["886885833"] = 3751.2768108491855,
         ["715144259"] = 3734.9442977311496,
         ["430281807"] = 3738.693964915332,
         ["543966758"] = 3733.529667032391
      },

      ["1024"] = {
         ["670828913"] = 3490.6678379722,
         ["886885833"] = 3527.1128893562063,
         ["715144259"] = 3519.4651927688733,
         ["430281807"] = 3501.0831187165945,
         ["543966758"] = 3490.6522517125404
      },

      ["10000"] = {
         ["670828913"] = 3444.7316097727303,
         ["886885833"] = 3465.8069086364203,
         ["715144259"] = 3483.2543555026887,
         ["430281807"] = 3481.392529578466,
         ["543966758"] = 3467.3923317768076
      }
   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 3705.5350305468605,
         ["886885833"] = 3703.1768763876216,
         ["715144259"] = 3694.6501655984534,
         ["430281807"] = 3672.927210954181,
         ["543966758"] = 3671.879830078779
      },

      ["1024"] = {
         ["670828913"] = 3505.113559455805,
         ["886885833"] = 3497.8298493087086,
         ["715144259"] = 3462.8372505268903,
         ["430281807"] = 3509.8595588148683,
         ["543966758"] = 3514.9874239263186
      },

      ["10000"] = {
         ["670828913"] = 3404.70929309734,
         ["886885833"] = 3461.6892486242236,
         ["715144259"] = 3430.4468774495745,
         ["430281807"] = 3435.6044715675343,
         ["543966758"] = 3435.063118683862
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 3595.3639926334613,
         ["886885833"] = 3603.4786407266633,
         ["715144259"] = 3592.519506018406,
         ["430281807"] = 3623.2873425684097,
         ["543966758"] = 3578.0706128828715
      },

      ["1024"] = {
         ["670828913"] = 3277.5468253471126,
         ["886885833"] = 3406.2871100671346,
         ["715144259"] = 3272.666878481026,
         ["430281807"] = 3305.403354917275,
         ["543966758"] = 3321.6711303355796
      },

      ["10000"] = {
         ["670828913"] = 3585.049639990605,
         ["886885833"] = 3526.232756590913,
         ["715144259"] = 3581.178074806322,
         ["430281807"] = 3588.6959510073875,
         ["543966758"] = 3534.462175659743
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 3520.0754350464276,
         ["886885833"] = 3514.199548273586,
         ["715144259"] = 3545.01452182166,
         ["430281807"] = 3559.4300337327245,
         ["543966758"] = 3534.278868578746
      },

      ["1024"] = {
         ["670828913"] = 3517.5806327174496,
         ["886885833"] = 3596.8347575963962,
         ["715144259"] = 3516.87736077023,
         ["430281807"] = 3547.37667482055,
         ["543966758"] = 3620.7555060655395
      },

      ["10000"] = {
         ["670828913"] = 3460.7406705670774,
         ["886885833"] = 3528.8646557006928,
         ["715144259"] = 3478.496516513782,
         ["430281807"] = 3421.454536442425,
         ["543966758"] = 3527.9836893119664
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 3696.967974564626,
         ["886885833"] = 3712.943537505566,
         ["715144259"] = 3702.9906100970297,
         ["430281807"] = 3732.001684884005,
         ["543966758"] = 3716.8954786389677
      },

      ["1024"] = {
         ["670828913"] = 3566.3258095035303,
         ["886885833"] = 3570.5888938727803,
         ["715144259"] = 3562.0760506306265,
         ["430281807"] = 3532.4253533857295,
         ["543966758"] = 3590.3273998915965
      },

      ["10000"] = {
         ["670828913"] = 3810.564037821061,
         ["886885833"] = 3821.6881033330237,
         ["715144259"] = 3820.521238053115,
         ["430281807"] = 3851.6288753325744,
         ["543966758"] = 3925.8562559152815
      }
   },

   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 3744.3316246476616,
         ["886885833"] = 3756.6827874877104,
         ["715144259"] = 3704.2218712691847,
         ["430281807"] = 3700.689893943871,
         ["543966758"] = 3754.7936448506903
      },

      ["1024"] = {
         ["670828913"] = 3404.360339082625,
         ["886885833"] = 3432.943640625923,
         ["715144259"] = 3464.890001006141,
         ["430281807"] = 3408.899138842276,
         ["543966758"] = 3362.4936696865725
      },

      ["10000"] = {
         ["670828913"] = 3396.075435752983,
         ["886885833"] = 3472.6105405617104,
         ["715144259"] = 3414.5791360708313,
         ["430281807"] = 3403.5139762146164,
         ["543966758"] = 3364.8476360349896
      }
   },

   ["model_newhist1"] = {
      ["100"] = {
         ["670828913"] = 4966.48276998534,
         ["886885833"] = 4958.154578970775,
         ["715144259"] = 4929.421613966311,
         ["430281807"] = 4887.570744555448,
         ["543966758"] = 4949.190706140736
      },

      ["1024"] = {
         ["670828913"] = 4782.809413175841,
         ["886885833"] = 4755.042271485647,
         ["715144259"] = 4731.2984298245065,
         ["430281807"] = 4766.833902549984,
         ["543966758"] = 4818.170356310189
      },

      ["10000"] = {
         ["670828913"] = 4691.548943770171,
         ["886885833"] = 4772.884152497657,
         ["715144259"] = 4891.8834004804985,
         ["430281807"] = 4911.596752410866,
         ["543966758"] = 4515.484288221107
      }
   },

   ["model_newhist2"] = {
      ["100"] = {
         ["670828913"] = 4954.3292398185395,
         ["886885833"] = 4971.143170139772,
         ["715144259"] = 4962.181076005238,
         ["430281807"] = 4944.660599740899,
         ["543966758"] = 4925.059084812762
      },

      ["1024"] = {
         ["670828913"] = 4864.207650343004,
         ["886885833"] = 4880.826623110273,
         ["715144259"] = 4685.815799619143,
         ["430281807"] = 4769.925331787363,
         ["543966758"] = 4753.987264388171
      },

      ["10000"] = {
         ["670828913"] = 4508.264660708079,
         ["886885833"] = 4616.163831307586,
         ["715144259"] = 4596.430039203204,
         ["430281807"] = 4591.568184832863,
         ["543966758"] = 4528.399647417762
      }
   },

   ["model_newhist3"] = {
      ["100"] = {
         ["670828913"] = 4946.940207077804,
         ["886885833"] = 4938.58226813623,
         ["715144259"] = 4893.3242756275995,
         ["430281807"] = 4915.160624177701,
         ["543966758"] = 4925.0642858901165
      },

      ["1024"] = {
         ["670828913"] = 5857.270811448854,
         ["886885833"] = 5417.726217674651,
         ["715144259"] = 6205.908389071744,
         ["430281807"] = 6012.6175628818155,
         ["543966758"] = 6034.054740746972
      },

      ["10000"] = {
         ["670828913"] = 6640.29767988169,
         ["886885833"] = 5826.627319249144,
         ["715144259"] = 6184.158056152769,
         ["430281807"] = 6105.533684905817,
         ["543966758"] = 6010.356542200352
      }
   },

   ["model_LMC"] = {
      ["100"] = {
         ["670828913"] = 3632.6264043486512,
         ["886885833"] = 3627.1196505026555,
         ["715144259"] = 3642.1685686810342,
         ["430281807"] = 3625.7930413439303,
         ["543966758"] = 3624.9532434791763
      },

      ["1024"] = {
         ["670828913"] = 3525.236490850665,
         ["886885833"] = 3548.1682561290077,
         ["715144259"] = 3543.253500332909,
         ["430281807"] = 3568.270436835508,
         ["543966758"] = 3549.6721948877307
      },

      ["10000"] = {
         ["670828913"] = 3538.259364529271,
         ["886885833"] = 3552.027039338331,
         ["715144259"] = 3548.1315300767187,
         ["430281807"] = 3541.8128148275255,
         ["543966758"] = 3500.603963843153
      }
   },

   ["model_bar"] = {
      ["100"] = {
         ["670828913"] = 3539.8219190708305,
         ["886885833"] = 3538.359683961129,
         ["715144259"] = 3542.413251876098,
         ["430281807"] = 3561.4386871098077,
         ["543966758"] = 3561.672651227395
      },

      ["1024"] = {
         ["670828913"] = 3459.5189380526945,
         ["886885833"] = 3457.588827409937,
         ["715144259"] = 3459.113544695775,
         ["430281807"] = 3456.2747587811355,
         ["543966758"] = 3469.290661146484
      },

      ["10000"] = {
         ["670828913"] = 3395.2269238932795,
         ["886885833"] = 3393.952864234226,
         ["715144259"] = 3386.9443398689796,
         ["430281807"] = 3392.43927065189,
         ["543966758"] = 3397.6460636535594
      }
   },

   ["model_LMC_bar"] = {
      ["100"] = {
         ["670828913"] = 3631.302065389775,
         ["886885833"] = 3626.945067564657,
         ["715144259"] = 3636.662563027169,
         ["430281807"] = 3625.5877989848063,
         ["543966758"] = 3625.4687485169325
      },

      ["1024"] = {
         ["670828913"] = 3541.7064143196617,
         ["886885833"] = 3559.5382317978233,
         ["715144259"] = 3520.7998084314654,
         ["430281807"] = 3532.2149531082,
         ["543966758"] = 3546.44489828367
      },

      ["10000"] = {
         ["670828913"] = 3545.72442384508,
         ["886885833"] = 3547.771818926971,
         ["715144259"] = 3542.3115279721837,
         ["430281807"] = 3531.858779402348,
         ["543966758"] = 3549.2912175489705
      }
   }
}

function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end
