
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
local testSeed = testSeeds[math.random(1, #testSeeds)]
--local testSeed = testSeeds[5]


refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 452.43477289338745,
         ["886885833"] = 461.2232501521903,
         ["715144259"] = 441.20275624190793,
         ["430281807"] = 565.6859138894265,
         ["543966758"] = 461.19348816485706
      },

      ["1024"] = {
         ["670828913"] = 223.7559033043697,
         ["886885833"] = 388.269259899758,
         ["715144259"] = 276.1419521869219,
         ["430281807"] = 189.91766905591933,
         ["543966758"] = 344.4654635136306
      },

      ["10000"] = {
         ["670828913"] = 515.8172830340084,
         ["886885833"] = 667.0502116802836,
         ["715144259"] = 554.654229649399,
         ["430281807"] = 573.5135652835152,
         ["543966758"] = 608.5187315854726
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 469.86783023717703,
         ["886885833"] = 525.1852678321268,
         ["715144259"] = 498.1335727829868,
         ["430281807"] = 486.11653789290364,
         ["543966758"] = 544.718804777276
      },

      ["1024"] = {
         ["670828913"] = 671.9785211450153,
         ["886885833"] = 731.1617703595301,
         ["715144259"] = 629.418403924912,
         ["430281807"] = 754.234965899881,
         ["543966758"] = 713.790155235896
      },

      ["10000"] = {
         ["670828913"] = 1599.2064279689132,
         ["886885833"] = 1617.9660688591184,
         ["715144259"] = 1625.351107006157,
         ["430281807"] = 1681.0780665465543,
         ["543966758"] = 1648.2841636422402
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 660.4889975689671,
         ["886885833"] = 614.1867599794587,
         ["715144259"] = 604.1690582308181,
         ["430281807"] = 762.327909373817,
         ["543966758"] = 636.5747696096726
      },

      ["1024"] = {
         ["670828913"] = 1284.6621711040423,
         ["886885833"] = 1478.1725321950105,
         ["715144259"] = 1205.058470869273,
         ["430281807"] = 1321.9313460207823,
         ["543966758"] = 1320.5678033949137
      },

      ["10000"] = {
         ["670828913"] = 2542.5460200529847,
         ["886885833"] = 2728.043333696995,
         ["715144259"] = 2576.898628060333,
         ["430281807"] = 2670.278186329085,
         ["543966758"] = 2621.629896363713
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 480.4190709635216,
         ["886885833"] = 478.13294950168194,
         ["715144259"] = 462.4616564592023,
         ["430281807"] = 478.39457611187123,
         ["543966758"] = 455.18870244599765
      },

      ["1024"] = {
         ["670828913"] = 165.0526237315074,
         ["886885833"] = 250.6666463890728,
         ["715144259"] = 241.73206760882147,
         ["430281807"] = 220.58607466353067,
         ["543966758"] = 254.76544669066598
      },

      ["10000"] = {
         ["670828913"] = 471.0690774528726,
         ["886885833"] = 472.11912984324,
         ["715144259"] = 477.27480734971755,
         ["430281807"] = 449.2243353896074,
         ["543966758"] = 434.19524479051483
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 462.6820504238,
         ["886885833"] = 451.18687019134256,
         ["715144259"] = 446.5299280034406,
         ["430281807"] = 466.2669643749624,
         ["543966758"] = 447.6322911737296
      },

      ["1024"] = {
         ["670828913"] = 290.89725451939256,
         ["886885833"] = 165.26681274941495,
         ["715144259"] = 238.79304374007913,
         ["430281807"] = 244.1648585015259,
         ["543966758"] = 332.4263391341335
      },

      ["10000"] = {
         ["670828913"] = 442.85633731928453,
         ["886885833"] = 529.4315600907485,
         ["715144259"] = 456.95128290169833,
         ["430281807"] = 489.7013903235189,
         ["543966758"] = 518.0025403874258
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 3559.0216321321204,
         ["886885833"] = 3520.062817420861,
         ["715144259"] = 3517.274504952003,
         ["430281807"] = 3562.90260148394,
         ["543966758"] = 3546.312056180678
      },

      ["1024"] = {
         ["670828913"] = 3575.7232383102273,
         ["886885833"] = 3652.5194336641334,
         ["715144259"] = 3585.553499204376,
         ["430281807"] = 3620.2134551038876,
         ["543966758"] = 3592.2996952482904
      },

      ["10000"] = {
         ["670828913"] = 3483.051322529342,
         ["886885833"] = 3488.72877948299,
         ["715144259"] = 3500.557976565575,
         ["430281807"] = 3525.643444131294,
         ["543966758"] = 3534.003303068412
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 458.38207728609484,
         ["886885833"] = 451.1658078958776,
         ["715144259"] = 456.31756565099977,
         ["430281807"] = 453.5947459341844,
         ["543966758"] = 446.8772891478503
      },

      ["1024"] = {
         ["670828913"] = 164.99789804719342,
         ["886885833"] = 145.4959522961767,
         ["715144259"] = 170.83640693596442,
         ["430281807"] = 166.06718023739262,
         ["543966758"] = 220.536119145346
      },

      ["10000"] = {
         ["670828913"] = 374.08452847194644,
         ["886885833"] = 353.54027603889494,
         ["715144259"] = 363.6090101329605,
         ["430281807"] = 333.2055548549163,
         ["543966758"] = 306.1564131953336
      }
   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 457.0687690618958,
         ["886885833"] = 448.3015202965311,
         ["715144259"] = 450.4289213706545,
         ["430281807"] = 473.0907171957417,
         ["543966758"] = 453.3155847827886
      },

      ["1024"] = {
         ["670828913"] = 233.24383528051845,
         ["886885833"] = 291.1282579421446,
         ["715144259"] = 234.96126723548593,
         ["430281807"] = 234.03863651327617,
         ["543966758"] = 384.3579693722148
      },

      ["10000"] = {
         ["670828913"] = 343.8076885597965,
         ["886885833"] = 519.6169611743061,
         ["715144259"] = 443.3077577659633,
         ["430281807"] = 442.40689451255366,
         ["543966758"] = 409.9729017536256
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 454.4416688409819,
         ["886885833"] = 451.2835687117335,
         ["715144259"] = 455.58554011071453,
         ["430281807"] = 471.81725732899963,
         ["543966758"] = 452.5958335716872
      },

      ["1024"] = {
         ["670828913"] = 191.98601917183987,
         ["886885833"] = 187.46087039327082,
         ["715144259"] = 151.79226724728494,
         ["430281807"] = 194.27908699753482,
         ["543966758"] = 194.15806995831838
      },

      ["10000"] = {
         ["670828913"] = 286.8105593045272,
         ["886885833"] = 350.08146675302237,
         ["715144259"] = 328.04779366662257,
         ["430281807"] = 317.90553106864667,
         ["543966758"] = 327.6121526152417
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 448.9788027660416,
         ["886885833"] = 458.77909375195844,
         ["715144259"] = 448.75514660283653,
         ["430281807"] = 436.7130728726695,
         ["543966758"] = 466.3518497931271
      },

      ["1024"] = {
         ["670828913"] = 269.8716461337869,
         ["886885833"] = 214.38349974735743,
         ["715144259"] = 226.74525902591793,
         ["430281807"] = 258.046304546177,
         ["543966758"] = 235.81062685258058
      },

      ["10000"] = {
         ["670828913"] = 129.10766206161105,
         ["886885833"] = 119.90567458931329,
         ["715144259"] = 126.83228082435585,
         ["430281807"] = 132.206360031747,
         ["543966758"] = 137.20543835483755
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 456.02090862918413,
         ["886885833"] = 458.37094495505534,
         ["715144259"] = 459.68360260066544,
         ["430281807"] = 460.53607337573607,
         ["543966758"] = 460.41001465814816
      },

      ["1024"] = {
         ["670828913"] = 242.1156865361233,
         ["886885833"] = 230.5725867324876,
         ["715144259"] = 259.2752812495826,
         ["430281807"] = 202.04449064264867,
         ["543966758"] = 239.56757255547495
      },

      ["10000"] = {
         ["670828913"] = 279.9797074270091,
         ["886885833"] = 392.95577659294975,
         ["715144259"] = 336.7817744746596,
         ["430281807"] = 323.7455375871973,
         ["543966758"] = 311.760835909361
      }
   },

   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 520.8612296811241,
         ["886885833"] = 523.5005267755542,
         ["715144259"] = 496.51501280842564,
         ["430281807"] = 511.52257040953043,
         ["543966758"] = 487.62833985549014
      },

      ["1024"] = {
         ["670828913"] = 302.8003561253261,
         ["886885833"] = 403.1730388481979,
         ["715144259"] = 377.90251420686616,
         ["430281807"] = 315.6131154731031,
         ["543966758"] = 340.3433030253392
      },

      ["10000"] = {
         ["670828913"] = 698.3865985898103,
         ["886885833"] = 750.1921276210866,
         ["715144259"] = 761.4590075800863,
         ["430281807"] = 731.5545570287226,
         ["543966758"] = 731.5538416829836
      }
   },

   ["model_newhist1"] = {
      ["100"] = {
         ["670828913"] = 1732.0543163686318,
         ["886885833"] = 1715.0263591609496,
         ["715144259"] = 1727.310326903499,
         ["430281807"] = 1722.6557430264156,
         ["543966758"] = 1742.486933126674
      },

      ["1024"] = {
         ["670828913"] = 1077.1595445377693,
         ["886885833"] = 1085.0564266614324,
         ["715144259"] = 946.5776235440646,
         ["430281807"] = 933.3689946411787,
         ["543966758"] = 871.9559354372009
      },

      ["10000"] = {
         ["670828913"] = 2726.180023873662,
         ["886885833"] = 2709.6563182438795,
         ["715144259"] = 2766.359914066434,
         ["430281807"] = 2810.5380349770917,
         ["543966758"] = 2798.4997723188017
      }
   },

   ["model_newhist2"] = {
      ["100"] = {
         ["670828913"] = 1717.5418761133617,
         ["886885833"] = 1720.5187166668627,
         ["715144259"] = 1742.0010756657775,
         ["430281807"] = 1704.8234129897535,
         ["543966758"] = 1736.9081352088324
      },

      ["1024"] = {
         ["670828913"] = 766.5053671272159,
         ["886885833"] = 731.5587535677439,
         ["715144259"] = 974.6922365369925,
         ["430281807"] = 706.7471977140574,
         ["543966758"] = 612.6665617456326
      },

      ["10000"] = {
         ["670828913"] = 1036.5578782925293,
         ["886885833"] = 1437.5690276149353,
         ["715144259"] = 1504.6894710263564,
         ["430281807"] = 1371.553338443572,
         ["543966758"] = 1273.4817919477973
      }
   },

   ["model_newhist3"] = {
      ["100"] = {
         ["670828913"] = 1717.7298019165403,
         ["886885833"] = 1715.4092743640392,
         ["715144259"] = 1716.4544775230327,
         ["430281807"] = 1717.029402001306,
         ["543966758"] = 1729.7429100800616
      },

      ["1024"] = {
         ["670828913"] = 835.5186878712948,
         ["886885833"] = 975.2700784724208,
         ["715144259"] = 1019.707994986481,
         ["430281807"] = 849.8053649634861,
         ["543966758"] = 1055.5140984081563
      },

      ["10000"] = {
         ["670828913"] = 2515.5228997740865,
         ["886885833"] = 2476.931855869287,
         ["715144259"] = 2869.112423296427,
         ["430281807"] = 2923.6857220587212,
         ["543966758"] = 2288.605019247765
      }
   },

   ["model_LMC"] = {
      ["100"] = {
         ["670828913"] = 657.4162035823116,
         ["886885833"] = 631.6058071797933,
         ["715144259"] = 637.6519839997344,
         ["430281807"] = 659.6480824027118,
         ["543966758"] = 631.192810940621
      },

      ["1024"] = {
         ["670828913"] = 708.8157341330867,
         ["886885833"] = 721.5936819753605,
         ["715144259"] = 698.4906929458216,
         ["430281807"] = 804.0407450871221,
         ["543966758"] = 809.5667013967209
      },

      ["10000"] = {
         ["670828913"] = 1714.7154077794053,
         ["886885833"] = 1731.6665569560164,
         ["715144259"] = 1677.8215156686394,
         ["430281807"] = 1699.439724449786,
         ["543966758"] = 1723.3404362881133
      }
   },

   ["model_bar"] = {
      ["100"] = {
         ["670828913"] = 466.62124385976256,
         ["886885833"] = 481.40061718083894,
         ["715144259"] = 482.30670089266096,
         ["430281807"] = 558.8793713400765,
         ["543966758"] = 473.9524182625826
      },

      ["1024"] = {
         ["670828913"] = 549.0561844419783,
         ["886885833"] = 542.733702035081,
         ["715144259"] = 616.0346768492556,
         ["430281807"] = 657.7399781045965,
         ["543966758"] = 536.1771299172767
      },

      ["10000"] = {
         ["670828913"] = 415.51228903989164,
         ["886885833"] = 539.186774087588,
         ["715144259"] = 413.3232156196658,
         ["430281807"] = 535.2138713834665,
         ["543966758"] = 482.2225452044682
      }
   },

   ["model_LMC_bar"] = {
      ["100"] = {
         ["670828913"] = 692.3121767111386,
         ["886885833"] = 735.6348059040731,
         ["715144259"] = 725.5453769856008,
         ["430281807"] = 957.149262055496,
         ["543966758"] = 836.9849220062393
      },

      ["1024"] = {
         ["670828913"] = 941.8709320732946,
         ["886885833"] = 1222.289762888734,
         ["715144259"] = 1104.5481205322633,
         ["430281807"] = 1125.7347103965076,
         ["543966758"] = 1100.9123037041472
      },

      ["10000"] = {
         ["670828913"] = 2022.199589040585,
         ["886885833"] = 2131.0816702092043,
         ["715144259"] = 2052.8394549088157,
         ["430281807"] = 2070.310171527076,
         ["543966758"] = 2121.668437930091
      }
   }
}


function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end
