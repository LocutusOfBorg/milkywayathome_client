
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
local testSeed = testSeeds[math.random(1, #testSeeds)]
--local testSeed = testSeeds[5]


refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 452.434772893,
         ["886885833"] = 461.223250152,
         ["715144259"] = 441.202756242,
         ["430281807"] = 565.685913889,
         ["543966758"] = 461.193488165
      },

      ["1024"] = {
         ["670828913"] = 223.755903304,
         ["886885833"] = 388.2692599,
         ["715144259"] = 276.141952187,
         ["430281807"] = 189.917669056,
         ["543966758"] = 344.465463514
      },

      ["10000"] = {
         ["670828913"] = 515.817283034,
         ["886885833"] = 667.05021168,
         ["715144259"] = 554.654229649,
         ["430281807"] = 573.513565284,
         ["543966758"] = 608.518731585
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 526.417321474,
         ["886885833"] = 483.87735522,
         ["715144259"] = 548.780476804,
         ["430281807"] = 665.898115203,
         ["543966758"] = 777.118269578
      },

      ["1024"] = {
         ["670828913"] = 854.656180897,
         ["886885833"] = 1073.21432325,
         ["715144259"] = 868.187709087,
         ["430281807"] = 855.334090608,
         ["543966758"] = 1054.94662767
      },

      ["10000"] = {
         ["670828913"] = 1788.81318169,
         ["886885833"] = 1840.75788233,
         ["715144259"] = 1841.01096736,
         ["430281807"] = 1879.8230152,
         ["543966758"] = 1960.45791951
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 695.273330805,
         ["886885833"] = 682.83995208,
         ["715144259"] = 622.918241043,
         ["430281807"] = 744.484378862,
         ["543966758"] = 656.957575162
      },

      ["1024"] = {
         ["670828913"] = 1216.56480785,
         ["886885833"] = 1388.06023789,
         ["715144259"] = 1222.35148781,
         ["430281807"] = 1317.30039235,
         ["543966758"] = 1305.09982422
      },

      ["10000"] = {
         ["670828913"] = 2563.22338846,
         ["886885833"] = 2703.70693839,
         ["715144259"] = 2600.9499425,
         ["430281807"] = 2616.91872415,
         ["543966758"] = 2589.96641084
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 459.507687142,
         ["886885833"] = 458.247766071,
         ["715144259"] = 455.975816361,
         ["430281807"] = 476.798495853,
         ["543966758"] = 470.810363009
      },

      ["1024"] = {
         ["670828913"] = 215.065166075,
         ["886885833"] = 305.873187602,
         ["715144259"] = 216.234077283,
         ["430281807"] = 227.173376203,
         ["543966758"] = 244.182618655
      },

      ["10000"] = {
         ["670828913"] = 480.517429857,
         ["886885833"] = 580.426516861,
         ["715144259"] = 527.717833116,
         ["430281807"] = 496.325212916,
         ["543966758"] = 476.530238263
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 464.136651091,
         ["886885833"] = 458.264282776,
         ["715144259"] = 469.909126013,
         ["430281807"] = 490.961564793,
         ["543966758"] = 441.598917324
      },

      ["1024"] = {
         ["670828913"] = 177.805830658,
         ["886885833"] = 423.581870479,
         ["715144259"] = 266.176114454,
         ["430281807"] = 305.880654571,
         ["543966758"] = 359.145734429
      },

      ["10000"] = {
         ["670828913"] = 434.58324628,
         ["886885833"] = 591.379999982,
         ["715144259"] = 467.408735416,
         ["430281807"] = 462.476442548,
         ["543966758"] = 586.75837469
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 3465.03469917,
         ["886885833"] = 3555.7345344,
         ["715144259"] = 3579.15133125,
         ["430281807"] = 3516.48676649,
         ["543966758"] = 3511.2967202
      },

      ["1024"] = {
         ["670828913"] = 3575.79656627,
         ["886885833"] = 3569.04393205,
         ["715144259"] = 3553.95297439,
         ["430281807"] = 3544.10166346,
         ["543966758"] = 3558.30814308
      },

      ["10000"] = {
         ["670828913"] = 3438.82512432,
         ["886885833"] = 3456.08502986,
         ["715144259"] = 3462.02370885,
         ["430281807"] = 3494.74385085,
         ["543966758"] = 3505.69108348
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 458.382077286,
         ["886885833"] = 451.165807896,
         ["715144259"] = 456.317565651,
         ["430281807"] = 453.594745934,
         ["543966758"] = 446.877289148
      },

      ["1024"] = {
         ["670828913"] = 164.997898047,
         ["886885833"] = 145.495952296,
         ["715144259"] = 170.836406936,
         ["430281807"] = 166.067180237,
         ["543966758"] = 220.536119145
      },

      ["10000"] = {
         ["670828913"] = 374.084528472,
         ["886885833"] = 353.540276039,
         ["715144259"] = 363.609010133,
         ["430281807"] = 333.205554855,
         ["543966758"] = 306.156413195
      }
   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 463.521830688,
         ["886885833"] = 450.690397291,
         ["715144259"] = 507.179227654,
         ["430281807"] = 468.167403829,
         ["543966758"] = 471.881502634
      },

      ["1024"] = {
         ["670828913"] = 164.880872219,
         ["886885833"] = 347.356661375,
         ["715144259"] = 334.385627592,
         ["430281807"] = 162.044062752,
         ["543966758"] = 350.380284371
      },

      ["10000"] = {
         ["670828913"] = 425.408681119,
         ["886885833"] = 553.043139759,
         ["715144259"] = 525.297682282,
         ["430281807"] = 494.340233988,
         ["543966758"] = 512.243818069
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 454.441668841,
         ["886885833"] = 451.283568712,
         ["715144259"] = 455.585540111,
         ["430281807"] = 471.817257329,
         ["543966758"] = 452.595833572
      },

      ["1024"] = {
         ["670828913"] = 191.986019172,
         ["886885833"] = 187.460870393,
         ["715144259"] = 151.792267247,
         ["430281807"] = 194.279086998,
         ["543966758"] = 194.158069958
      },

      ["10000"] = {
         ["670828913"] = 286.810559305,
         ["886885833"] = 350.081466753,
         ["715144259"] = 328.047793667,
         ["430281807"] = 317.905531069,
         ["543966758"] = 327.612152615
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 465.978705298,
         ["886885833"] = 476.693575614,
         ["715144259"] = 446.884489842,
         ["430281807"] = 449.937765405,
         ["543966758"] = 461.496107587
      },

      ["1024"] = {
         ["670828913"] = 240.507923137,
         ["886885833"] = 285.001050955,
         ["715144259"] = 209.781460192,
         ["430281807"] = 177.529306576,
         ["543966758"] = 288.796034333
      },

      ["10000"] = {
         ["670828913"] = 121.846042372,
         ["886885833"] = 133.470058482,
         ["715144259"] = 119.756665648,
         ["430281807"] = 117.769959887,
         ["543966758"] = 143.122183773
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 456.020908629,
         ["886885833"] = 458.370944955,
         ["715144259"] = 459.683602601,
         ["430281807"] = 460.536073376,
         ["543966758"] = 460.410014658
      },

      ["1024"] = {
         ["670828913"] = 242.115686536,
         ["886885833"] = 230.572586732,
         ["715144259"] = 259.27528125,
         ["430281807"] = 202.044490643,
         ["543966758"] = 239.567572555
      },

      ["10000"] = {
         ["670828913"] = 279.979707427,
         ["886885833"] = 392.955776593,
         ["715144259"] = 336.781774475,
         ["430281807"] = 323.745537587,
         ["543966758"] = 311.760835909
      }
   },

   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 468.907114275,
         ["886885833"] = 506.443923917,
         ["715144259"] = 506.932529339,
         ["430281807"] = 554.343690716,
         ["543966758"] = 539.803458642
      },

      ["1024"] = {
         ["670828913"] = 455.205955134,
         ["886885833"] = 560.624359203,
         ["715144259"] = 377.709231599,
         ["430281807"] = 477.840494763,
         ["543966758"] = 581.46262853
      },

      ["10000"] = {
         ["670828913"] = 841.129077907,
         ["886885833"] = 936.45219443,
         ["715144259"] = 878.363670196,
         ["430281807"] = 946.823092565,
         ["543966758"] = 907.627483457
      }
   },

   ["model_newhist1"] = {
      ["100"] = {
         ["670828913"] = 1747.72641912,
         ["886885833"] = 1721.12226085,
         ["715144259"] = 1731.21035047,
         ["430281807"] = 1728.111444,
         ["543966758"] = 1745.75429789
      },

      ["1024"] = {
         ["670828913"] = 1146.68694651,
         ["886885833"] = 1028.87468553,
         ["715144259"] = 1097.10919945,
         ["430281807"] = 906.856918514,
         ["543966758"] = 1163.97599685
      },

      ["10000"] = {
         ["670828913"] = 2799.74963283,
         ["886885833"] = 2647.27752254,
         ["715144259"] = 2915.88138183,
         ["430281807"] = 2778.59057419,
         ["543966758"] = 2836.9108645
      }
   },

   ["model_newhist2"] = {
      ["100"] = {
         ["670828913"] = 1717.54187611,
         ["886885833"] = 1720.51871667,
         ["715144259"] = 1742.00107567,
         ["430281807"] = 1704.82341299,
         ["543966758"] = 1736.90813521
      },

      ["1024"] = {
         ["670828913"] = 766.505367127,
         ["886885833"] = 731.558753568,
         ["715144259"] = 974.692236537,
         ["430281807"] = 706.747197714,
         ["543966758"] = 612.666561746
      },

      ["10000"] = {
         ["670828913"] = 1036.55787829,
         ["886885833"] = 1437.56902761,
         ["715144259"] = 1504.68947103,
         ["430281807"] = 1371.55333844,
         ["543966758"] = 1273.48179195
      }
   },

   ["model_newhist3"] = {
      ["100"] = {
         ["670828913"] = 1722.77806776,
         ["886885833"] = 1735.37193548,
         ["715144259"] = 1733.64183873,
         ["430281807"] = 1698.2386472,
         ["543966758"] = 1709.27219591
      },

      ["1024"] = {
         ["670828913"] = 974.78757506,
         ["886885833"] = 1221.24583887,
         ["715144259"] = 1040.60501285,
         ["430281807"] = 978.372380408,
         ["543966758"] = 1090.38164178
      },

      ["10000"] = {
         ["670828913"] = 2795.2210818,
         ["886885833"] = 2715.03957437,
         ["715144259"] = 2647.973016,
         ["430281807"] = 2865.77822292,
         ["543966758"] = 2516.6045436
      }
   },

   ["model_LMC"] = {
      ["100"] = {
         ["670828913"] = 710.043008231,
         ["886885833"] = 700.613493937,
         ["715144259"] = 674.676919128,
         ["430281807"] = 761.078966835,
         ["543966758"] = 685.871544783
      },

      ["1024"] = {
         ["670828913"] = 1021.93425005,
         ["886885833"] = 1221.58097034,
         ["715144259"] = 1134.17266436,
         ["430281807"] = 1016.1784894,
         ["543966758"] = 1133.95591398
      },

      ["10000"] = {
         ["670828913"] = 2369.99127965,
         ["886885833"] = 2426.4600226,
         ["715144259"] = 2391.83332886,
         ["430281807"] = 2375.64853989,
         ["543966758"] = 2376.22961333
      }
   },

   ["model_bar"] = {
      ["100"] = {
         ["670828913"] = 466.62124386,
         ["886885833"] = 481.400617181,
         ["715144259"] = 482.306700893,
         ["430281807"] = 558.87937134,
         ["543966758"] = 473.952418263
      },

      ["1024"] = {
         ["670828913"] = 549.056184442,
         ["886885833"] = 542.733702035,
         ["715144259"] = 616.034676849,
         ["430281807"] = 657.739978105,
         ["543966758"] = 536.177129917
      },

      ["10000"] = {
         ["670828913"] = 415.51228904,
         ["886885833"] = 539.186774088,
         ["715144259"] = 413.32321562,
         ["430281807"] = 535.213871383,
         ["543966758"] = 482.222545204
      }
   },

   ["model_LMC_bar"] = {
      ["100"] = {
         ["670828913"] = 708.88418266,
         ["886885833"] = 721.809436367,
         ["715144259"] = 623.410341207,
         ["430281807"] = 765.552531924,
         ["543966758"] = 670.071912893
      },

      ["1024"] = {
         ["670828913"] = 1029.57287112,
         ["886885833"] = 1143.47299827,
         ["715144259"] = 1057.32916852,
         ["430281807"] = 992.334991812,
         ["543966758"] = 1182.85369527
      },

      ["10000"] = {
         ["670828913"] = 2376.49621126,
         ["886885833"] = 2409.57886753,
         ["715144259"] = 2384.24650667,
         ["430281807"] = 2351.39285792,
         ["543966758"] = 2396.84948133
      }
   }}



function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end
