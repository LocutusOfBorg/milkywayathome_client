
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
local testSeed = testSeeds[math.random(1, #testSeeds)]
--local testSeed = testSeeds[5]

refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 3491.722527816045,
         ["886885833"] = 3494.3677384672615,
         ["715144259"] = 3495.497770475216,
         ["430281807"] = 3488.0052863981628,
         ["543966758"] = 3492.680676447446
      },

      ["1024"] = {
         ["670828913"] = 3502.276999365643,
         ["886885833"] = 3479.1802345282786,
         ["715144259"] = 3490.2726117469188,
         ["430281807"] = 3496.981765655598,
         ["543966758"] = 3485.1384871215487
      },

      ["10000"] = {
         ["670828913"] = 3465.726848082078,
         ["886885833"] = 3435.6734818439836,
         ["715144259"] = 3438.895651795967,
         ["430281807"] = 3443.1471465743202,
         ["543966758"] = 3445.0879032983703
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 3501.8665848396768,
         ["886885833"] = 3505.0419254344506,
         ["715144259"] = 3495.453793035395,
         ["430281807"] = 3508.8821186389437,
         ["543966758"] = 3511.6826609137966
      },

      ["1024"] = {
         ["670828913"] = 3532.273720546855,
         ["886885833"] = 3522.273383080231,
         ["715144259"] = 3540.1804410813847,
         ["430281807"] = 3538.2679110159343,
         ["543966758"] = 3523.0250675315956
      },

      ["10000"] = {
         ["670828913"] = 3534.5894411426034,
         ["886885833"] = 3530.9674400105373,
         ["715144259"] = 3543.0872957170177,
         ["430281807"] = 3535.6519755817017,
         ["543966758"] = 3524.4390721179075
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 3513.071196539445,
         ["886885833"] = 3514.953456044307,
         ["715144259"] = 3506.371147648831,
         ["430281807"] = 3518.7485872977372,
         ["543966758"] = 3527.046968670138
      },

      ["1024"] = {
         ["670828913"] = 3558.7017389688426,
         ["886885833"] = 3541.3315377293357,
         ["715144259"] = 3561.67410156823,
         ["430281807"] = 3559.900726755659,
         ["543966758"] = 3542.992853493262
      },

      ["10000"] = {
         ["670828913"] = 3558.284199228454,
         ["886885833"] = 3555.0323252277803,
         ["715144259"] = 3558.912541245996,
         ["430281807"] = 3551.628175384651,
         ["543966758"] = 3556.6886290190905
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 3565.965369788036,
         ["886885833"] = 3573.036693996175,
         ["715144259"] = 3552.9187083734732,
         ["430281807"] = 3558.485381919741,
         ["543966758"] = 3559.0469076882246
      },

      ["1024"] = {
         ["670828913"] = 3501.5051122155696,
         ["886885833"] = 3525.7141325059283,
         ["715144259"] = 3529.557733526586,
         ["430281807"] = 3517.1630231507706,
         ["543966758"] = 3511.3906615951482
      },

      ["10000"] = {
         ["670828913"] = 3489.6736322718143,
         ["886885833"] = 3483.7268559276113,
         ["715144259"] = 3494.1017305670575,
         ["430281807"] = 3488.229131392792,
         ["543966758"] = 3513.607437618272
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 3541.0802224204126,
         ["886885833"] = 3534.9761270980393,
         ["715144259"] = 3523.0055017572313,
         ["430281807"] = 3533.1495329516442,
         ["543966758"] = 3528.165904461073
      },

      ["1024"] = {
         ["670828913"] = 3383.1169634760736,
         ["886885833"] = 3456.552028173938,
         ["715144259"] = 3409.887238111343,
         ["430281807"] = 3431.959995923399,
         ["543966758"] = 3390.5435904142487
      },

      ["10000"] = {
         ["670828913"] = 3457.8838352857065,
         ["886885833"] = 3461.8830828137625,
         ["715144259"] = 3449.273037570968,
         ["430281807"] = 3472.531020830439,
         ["543966758"] = 3473.1247073186305
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 3562.7361177209905,
         ["886885833"] = 3576.389721189301,
         ["715144259"] = 3560.392852164161,
         ["430281807"] = 3616.687999342119,
         ["543966758"] = 3577.15840923776
      },

      ["1024"] = {
         ["670828913"] = 3802.1687686413306,
         ["886885833"] = 3788.254932684049,
         ["715144259"] = 3788.058983778466,
         ["430281807"] = 3780.3979083955646,
         ["543966758"] = 3780.632343407139
      },

      ["10000"] = {
         ["670828913"] = 3866.9434417814064,
         ["886885833"] = 3894.13730777696,
         ["715144259"] = 3868.7516731141422,
         ["430281807"] = 3873.2516361195076,
         ["543966758"] = 3869.158285383232
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 3565.0067641468227,
         ["886885833"] = 3560.184480111604,
         ["715144259"] = 3545.561072462772,
         ["430281807"] = 3562.523548385635,
         ["543966758"] = 3547.0947636500373
      },

      ["1024"] = {
         ["670828913"] = 3514.31868490948,
         ["886885833"] = 3555.943962111429,
         ["715144259"] = 3570.509919674909,
         ["430281807"] = 3547.4597880640167,
         ["543966758"] = 3531.642007013197
      },

      ["10000"] = {
         ["670828913"] = 3526.471805839168,
         ["886885833"] = 3536.7614320917073,
         ["715144259"] = 3563.527424951073,
         ["430281807"] = 3542.6812273420524,
         ["543966758"] = 3539.359272560215
      }
   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 3549.5454501563777,
         ["886885833"] = 3551.6259948429447,
         ["715144259"] = 3548.192557910505,
         ["430281807"] = 3541.9897215925535,
         ["543966758"] = 3534.782944894767
      },

      ["1024"] = {
         ["670828913"] = 3531.9890487345056,
         ["886885833"] = 3565.9428732493325,
         ["715144259"] = 3510.5684757306026,
         ["430281807"] = 3523.936620141723,
         ["543966758"] = 3506.2235925148225
      },

      ["10000"] = {
         ["670828913"] = 3508.386313942573,
         ["886885833"] = 3545.7907721941538,
         ["715144259"] = 3519.029782450915,
         ["430281807"] = 3526.7143716862006,
         ["543966758"] = 3540.539279884615
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 3515.223017312292,
         ["886885833"] = 3518.3971411784164,
         ["715144259"] = 3514.0979749412068,
         ["430281807"] = 3525.9272782063895,
         ["543966758"] = 3508.28327138779
      },

      ["1024"] = {
         ["670828913"] = 3277.2293937362156,
         ["886885833"] = 3303.1053841887315,
         ["715144259"] = 3278.902621388096,
         ["430281807"] = 3277.322188973048,
         ["543966758"] = 3287.435280388014
      },

      ["10000"] = {
         ["670828913"] = 3478.2876478702146,
         ["886885833"] = 3476.6234202011724,
         ["715144259"] = 3496.258199068047,
         ["430281807"] = 3465.398179153535,
         ["543966758"] = 3471.8659697147955
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 3483.2394674843695,
         ["886885833"] = 3480.5479741951694,
         ["715144259"] = 3494.345984819261,
         ["430281807"] = 3500.533169123767,
         ["543966758"] = 3489.627664462112
      },

      ["1024"] = {
         ["670828913"] = 3661.7330520029495,
         ["886885833"] = 3737.711955571732,
         ["715144259"] = 3632.6747848878904,
         ["430281807"] = 3716.6694631423466,
         ["543966758"] = 3677.732398621844
      },

      ["10000"] = {
         ["670828913"] = 3950.2656864557584,
         ["886885833"] = 3923.16033302705,
         ["715144259"] = 3924.8250761806344,
         ["430281807"] = 3926.844401962471,
         ["543966758"] = 3945.3187787315355
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 3522.5439937302995,
         ["886885833"] = 3514.4198045250546,
         ["715144259"] = 3518.522411287866,
         ["430281807"] = 3527.678612403123,
         ["543966758"] = 3521.5780339522616
      },

      ["1024"] = {
         ["670828913"] = 3612.4164419159033,
         ["886885833"] = 3611.4926257667416,
         ["715144259"] = 3600.9787245154475,
         ["430281807"] = 3583.601993160295,
         ["543966758"] = 3626.1278864550945
      },

      ["10000"] = {
         ["670828913"] = 4176.795637327539,
         ["886885833"] = 4166.406312986419,
         ["715144259"] = 4155.085499075624,
         ["430281807"] = 4172.350353570238,
         ["543966758"] = 4177.403345203826
      }
   },

   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 3547.4489056685416,
         ["886885833"] = 3560.3494611799224,
         ["715144259"] = 3528.8903617044,
         ["430281807"] = 3528.5984917949886,
         ["543966758"] = 3541.879240530079
      },

      ["1024"] = {
         ["670828913"] = 3408.0047178046443,
         ["886885833"] = 3392.186699565865,
         ["715144259"] = 3415.193307972978,
         ["430281807"] = 3396.49262367456,
         ["543966758"] = 3394.0297042485818
      },

      ["10000"] = {
         ["670828913"] = 3407.420179323586,
         ["886885833"] = 3464.9791445368724,
         ["715144259"] = 3419.2982944927985,
         ["430281807"] = 3394.5085236701852,
         ["543966758"] = 3385.8576733383493
      }
   },

   ["model_newhist1"] = {
      ["100"] = {
         ["670828913"] = 4824.548689376794,
         ["886885833"] = 4815.03308718866,
         ["715144259"] = 5385.294477656413,
         ["430281807"] = 6927.399769831429,
         ["543966758"] = 4818.88910249045
      },

      ["1024"] = {
         ["670828913"] = 19574.803465123776,
         ["886885833"] = 20142.03708203582,
         ["715144259"] = 19245.622503156213,
         ["430281807"] = 19670.050466615372,
         ["543966758"] = 19226.458034064177
      },

      ["10000"] = {
         ["670828913"] = 27226.21413576036,
         ["886885833"] = 27243.937233992798,
         ["715144259"] = 27117.92938864362,
         ["430281807"] = 27303.844693911506,
         ["543966758"] = 27313.890121795233
      }
   },

   ["model_newhist2"] = {
      ["100"] = {
         ["670828913"] = 6445.9060141972805,
         ["886885833"] = 8012.317878763551,
         ["715144259"] = 6138.872777645905,
         ["430281807"] = 7416.864659426899,
         ["543966758"] = 6213.810901500632
      },

      ["1024"] = {
         ["670828913"] = 25698.57767400125,
         ["886885833"] = 25462.88855763826,
         ["715144259"] = 24442.858465029978,
         ["430281807"] = 24326.97549809811,
         ["543966758"] = 24260.561208576622
      },

      ["10000"] = {
         ["670828913"] = 32724.510555628847,
         ["886885833"] = 32797.16578981361,
         ["715144259"] = 32761.42554667305,
         ["430281807"] = 32632.661436004168,
         ["543966758"] = 32744.00833548806
      }
   },

   ["model_newhist3"] = {
      ["100"] = {
         ["670828913"] = 4818.136322760701,
         ["886885833"] = 4815.307627963728,
         ["715144259"] = 4971.627016575074,
         ["430281807"] = 4795.4130227644,
         ["543966758"] = 4810.621506163772
      },

      ["1024"] = {
         ["670828913"] = 12292.514534038275,
         ["886885833"] = 12737.948555682238,
         ["715144259"] = 12260.688401377063,
         ["430281807"] = 12756.82057276669,
         ["543966758"] = 11986.547626943247
      },

      ["10000"] = {
         ["670828913"] = 17265.88050933054,
         ["886885833"] = 17251.76270693284,
         ["715144259"] = 17174.493436660756,
         ["430281807"] = 17334.648648944873,
         ["543966758"] = 17225.700216732752
      }
   },

   ["model_LMC"] = {
      ["100"] = {
         ["670828913"] = 3512.156982827414,
         ["886885833"] = 3528.0427225455596,
         ["715144259"] = 3523.9954475163636,
         ["430281807"] = 3521.7868968764014,
         ["543966758"] = 3518.851116141782
      },

      ["1024"] = {
         ["670828913"] = 3547.0750111011835,
         ["886885833"] = 3572.2129227103933,
         ["715144259"] = 3538.4970925183325,
         ["430281807"] = 3568.9695899680287,
         ["543966758"] = 3568.8503985913876
      },

      ["10000"] = {
         ["670828913"] = 3515.889887705504,
         ["886885833"] = 3503.38403357841,
         ["715144259"] = 3503.4567508987184,
         ["430281807"] = 3498.385904291134,
         ["543966758"] = 3522.679069125018
      }
   },

   ["model_bar"] = {
      ["100"] = {
         ["670828913"] = 3459.54500641593,
         ["886885833"] = 3475.545949799825,
         ["715144259"] = 3476.6073020914587,
         ["430281807"] = 3474.201011120192,
         ["543966758"] = 3480.9893639366564
      },

      ["1024"] = {
         ["670828913"] = 3410.35227921309,
         ["886885833"] = 3425.089190157373,
         ["715144259"] = 3427.2992957686774,
         ["430281807"] = 3418.0100746942485,
         ["543966758"] = 3421.8207893446242
      },

      ["10000"] = {
         ["670828913"] = 3404.2782320148835,
         ["886885833"] = 3378.6917193505756,
         ["715144259"] = 3394.093307612778,
         ["430281807"] = 3382.652811945324,
         ["543966758"] = 3404.842208211041
      }
   },

   ["model_LMC_bar"] = {
      ["100"] = {
         ["670828913"] = 3507.2155793670972,
         ["886885833"] = 3526.301268896933,
         ["715144259"] = 3522.983024935282,
         ["430281807"] = 3523.909097886956,
         ["543966758"] = 3515.827147182767
      },

      ["1024"] = {
         ["670828913"] = 3552.920772291136,
         ["886885833"] = 3569.750972926864,
         ["715144259"] = 3531.734101734073,
         ["430281807"] = 3564.86488561022,
         ["543966758"] = 3546.839160110715
      },

      ["10000"] = {
         ["670828913"] = 3507.073856516849,
         ["886885833"] = 3495.417288621413,
         ["715144259"] = 3511.6598368927835,
         ["430281807"] = 3496.7610891257395,
         ["543966758"] = 3519.362254750567
      }
   }
}

function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end
