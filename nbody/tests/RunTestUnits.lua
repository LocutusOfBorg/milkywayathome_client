
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
--local testSeed = testSeeds[math.random(1, #testSeeds)]
local testSeed = testSeeds[5]

refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 1541.608627170455,
         ["886885833"] = 658.941450106519,
         ["715144259"] = 1548.8681574272364,
         ["430281807"] = 1070.3327550904605,
         ["543966758"] = 4848.545290799777
      },

      ["1024"] = {
         ["670828913"] = 2974.837081160555,
         ["886885833"] = 3438.5982726463053,
         ["715144259"] = 2927.601855983288,
         ["430281807"] = 3379.380487716745,
         ["543966758"] = 3355.981090256254
      },

      ["10000"] = {
         ["670828913"] = 4329.995042460903,
         ["886885833"] = 4295.977026086828,
         ["715144259"] = 4302.583266011392,
         ["430281807"] = 4196.177865634379,
         ["543966758"] = 4260.64876277237
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 1151.4469874751392,
         ["886885833"] = 1638.4472797076587,
         ["715144259"] = 1620.1043972918667,
         ["430281807"] = 1147.1548349717586,
         ["543966758"] = 4913.463438611959
      },

      ["1024"] = {
         ["670828913"] = 4121.07644327326,
         ["886885833"] = 4118.880318045446,
         ["715144259"] = 4111.432914477351,
         ["430281807"] = 4012.0734223525865,
         ["543966758"] = 4105.266921669665
      },

      ["10000"] = {
         ["670828913"] = 4655.01412933277,
         ["886885833"] = 4617.327993246162,
         ["715144259"] = 4651.320582254522,
         ["430281807"] = 4639.603074515304,
         ["543966758"] = 4633.91546277863
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 4845.945460762697,
         ["886885833"] = 4851.295042028858,
         ["715144259"] = 1099.6478985625995,
         ["430281807"] = 4857.7183435849975,
         ["543966758"] = 4862.993506774645
      },

      ["1024"] = {
         ["670828913"] = 4572.656232730846,
         ["886885833"] = 4219.46919130001,
         ["715144259"] = 4579.4811018022965,
         ["430281807"] = 4232.492167889508,
         ["543966758"] = 4352.556142747361
      },

      ["10000"] = {
         ["670828913"] = 4771.706279357482,
         ["886885833"] = 4751.641568310185,
         ["715144259"] = 4763.249687157133,
         ["430281807"] = 4756.035527537904,
         ["543966758"] = 4756.835028768411
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 582.6774555742614,
         ["886885833"] = 560.5567956588385,
         ["715144259"] = 580.4544747813864,
         ["430281807"] = 551.1489237495508,
         ["543966758"] = 537.4197582884125
      },

      ["1024"] = {
         ["670828913"] = 876.2202873624468,
         ["886885833"] = 952.4034872604511,
         ["715144259"] = 855.3078214787854,
         ["430281807"] = 896.3168710638333,
         ["543966758"] = 848.3566384930716
      },

      ["10000"] = {
         ["670828913"] = 1499.5305429880395,
         ["886885833"] = 1572.2998256251947,
         ["715144259"] = 1519.5670610497064,
         ["430281807"] = 1367.7344147349233,
         ["543966758"] = 1652.332833395173
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 464.4039220056845,
         ["886885833"] = 437.15889572427506,
         ["715144259"] = 435.79492310856847,
         ["430281807"] = 447.36447252378247,
         ["543966758"] = 440.3986542779788
      },

      ["1024"] = {
         ["670828913"] = 326.1895960635956,
         ["886885833"] = 349.14980482334977,
         ["715144259"] = 391.12305831004664,
         ["430281807"] = 345.196496154495,
         ["543966758"] = 313.303130322939
      },

      ["10000"] = {
         ["670828913"] = 752.1547629880936,
         ["886885833"] = 1080.2176748094787,
         ["715144259"] = 838.4182364798861,
         ["430281807"] = 715.244830927967,
         ["543966758"] = 717.6790709260788
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 2772.2106919129396,
         ["886885833"] = 2724.5257809184677,
         ["715144259"] = 2756.3356476142812,
         ["430281807"] = 2748.1566923026476,
         ["543966758"] = 2779.04589679028
      },

      ["1024"] = {
         ["670828913"] = 2805.552132193714,
         ["886885833"] = 2803.792233848222,
         ["715144259"] = 2795.573233042211,
         ["430281807"] = 2815.9517852591866,
         ["543966758"] = 2794.6771521426112
      },

      ["10000"] = {
         ["670828913"] = 2802.083265481851,
         ["886885833"] = 2811.77113154355,
         ["715144259"] = 2825.7359449960823,
         ["430281807"] = 2756.1069005104546,
         ["543966758"] = 2706.1212644455422
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 444.63924304453616,
         ["886885833"] = 440.52100087793855,
         ["715144259"] = 439.97287140142197,
         ["430281807"] = 435.5623101609889,
         ["543966758"] = 452.1770447068906
      },

      ["1024"] = {
         ["670828913"] = 174.95600285917084,
         ["886885833"] = 219.30307066470914,
         ["715144259"] = 163.97275430530797,
         ["430281807"] = 167.77052093349792,
         ["543966758"] = 218.41378373041778
      },

      ["10000"] = {
         ["670828913"] = 321.8468829587081,
         ["886885833"] = 332.9149712631858,
         ["715144259"] = 355.61393286354195,
         ["430281807"] = 374.30311645396375,
         ["543966758"] = 322.8422143307963
      }
   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 564.593723866608,
         ["886885833"] = 554.6734462672375,
         ["715144259"] = 581.1370968653778,
         ["430281807"] = 557.2183659683001,
         ["543966758"] = 556.6771487079358
      },

      ["1024"] = {
         ["670828913"] = 922.698114584739,
         ["886885833"] = 997.1573758527486,
         ["715144259"] = 908.9238977624005,
         ["430281807"] = 973.0690906784739,
         ["543966758"] = 925.0001105993861
      },

      ["10000"] = {
         ["670828913"] = 1666.011858738589,
         ["886885833"] = 1688.5008118331127,
         ["715144259"] = 1720.5473185085582,
         ["430281807"] = 1672.0463434867966,
         ["543966758"] = 1780.4545175362796
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 443.34309439321316,
         ["886885833"] = 444.28364134203184,
         ["715144259"] = 451.794399198343,
         ["430281807"] = 439.6640533055063,
         ["543966758"] = 441.55330731631693
      },

      ["1024"] = {
         ["670828913"] = 210.42491420557806,
         ["886885833"] = 230.71380326367796,
         ["715144259"] = 174.87644054949908,
         ["430281807"] = 201.40867581156516,
         ["543966758"] = 254.92046508797773
      },

      ["10000"] = {
         ["670828913"] = 384.6043177191938,
         ["886885833"] = 387.89506132635745,
         ["715144259"] = 394.99084678769054,
         ["430281807"] = 389.73528558336534,
         ["543966758"] = 383.0360711604093
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 519.8197046540845,
         ["886885833"] = 534.1636349292926,
         ["715144259"] = 550.6770954438699,
         ["430281807"] = 531.5784706363123,
         ["543966758"] = 523.6181377733267
      },

      ["1024"] = {
         ["670828913"] = 671.7293573090344,
         ["886885833"] = 657.7099982590238,
         ["715144259"] = 680.5452034355648,
         ["430281807"] = 620.7596657591015,
         ["543966758"] = 636.2719165648614
      },

      ["10000"] = {
         ["670828913"] = 1139.8729562636304,
         ["886885833"] = 1116.4320145045374,
         ["715144259"] = 1165.2307345080044,
         ["430281807"] = 1142.3223426273785,
         ["543966758"] = 1106.797512388579
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 4928.718123622824,
         ["886885833"] = 4935.849135819075,
         ["715144259"] = 4950.525140083778,
         ["430281807"] = 4938.256716964666,
         ["543966758"] = 4927.752695934388
      },

      ["1024"] = {
         ["670828913"] = 4911.932090297552,
         ["886885833"] = 4930.3987381217785,
         ["715144259"] = 4944.736067300632,
         ["430281807"] = 4917.886796977965,
         ["543966758"] = 4935.638417099742
      },

      ["10000"] = {
         ["670828913"] = 4883.151465516628,
         ["886885833"] = 4908.78097463274,
         ["715144259"] = 4889.388655984037,
         ["430281807"] = 4874.484835492509,
         ["543966758"] = 4899.750735931146
      }
   },

   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 589.5605964903026,
         ["886885833"] = 593.8546344178661,
         ["715144259"] = 579.4713953423369,
         ["430281807"] = 601.3667273200032,
         ["543966758"] = 636.8559118978851
      },

      ["1024"] = {
         ["670828913"] = 955.1079659839552,
         ["886885833"] = 1029.4781003019114,
         ["715144259"] = 948.0295277294431,
         ["430281807"] = 974.3098945502416,
         ["543966758"] = 1044.4541823003865
      },

      ["10000"] = {
         ["670828913"] = 1898.5960689439592,
         ["886885833"] = 2128.3165944351717,
         ["715144259"] = 2039.421049083541,
         ["430281807"] = 1973.6289806264276,
         ["543966758"] = 2088.13148690734
      }
   },

   ["model_newhist1"] = {
      ["100"] = {
         ["670828913"] = 3346.4722732757223,
         ["886885833"] = 4445.035888114359,
         ["715144259"] = 3250.109090359455,
         ["430281807"] = 3244.43649565519,
         ["543966758"] = 2613.293881583301
      },

      ["1024"] = {
         ["670828913"] = 4316.425592836741,
         ["886885833"] = 3599.723505882737,
         ["715144259"] = 3490.3310675054554,
         ["430281807"] = 4042.552287531049,
         ["543966758"] = 3372.1610850463294
      },

      ["10000"] = {
         ["670828913"] = 7612.707564210958,
         ["886885833"] = 7653.148709717966,
         ["715144259"] = 8896.760937375051,
         ["430281807"] = 7692.30132857857,
         ["543966758"] = 7053.4617266702635
      }
   },

   ["model_newhist2"] = {
      ["100"] = {
         ["670828913"] = 1715.722985458865,
         ["886885833"] = 1721.3012891350206,
         ["715144259"] = 1778.418686749933,
         ["430281807"] = 1706.6724958084587,
         ["543966758"] = 1724.2407304883468
      },

      ["1024"] = {
         ["670828913"] = 5016.91168288416,
         ["886885833"] = 3287.226154045703,
         ["715144259"] = 3702.689284490962,
         ["430281807"] = 4216.217850170386,
         ["543966758"] = 3840.735254473917
      },

      ["10000"] = {
         ["670828913"] = 15026.480332895377,
         ["886885833"] = 13007.860301038756,
         ["715144259"] = 13313.780475642896,
         ["430281807"] = 14021.853662181546,
         ["543966758"] = 13344.85482546012
      }
   },

   ["model_newhist3"] = {
      ["100"] = {
         ["670828913"] = 3363.0356764526514,
         ["886885833"] = 2704.555702214051,
         ["715144259"] = 2826.406017305864,
         ["430281807"] = 2587.1621337755782,
         ["543966758"] = 2999.3220134120784
      },

      ["1024"] = {
         ["670828913"] = 4289.917618312783,
         ["886885833"] = 3286.176755981659,
         ["715144259"] = 3231.3207880157347,
         ["430281807"] = 3079.7957616664467,
         ["543966758"] = 2520.895894434859
      },

      ["10000"] = {
         ["670828913"] = 5339.752526963655,
         ["886885833"] = 5264.339605121054,
         ["715144259"] = 5074.263946320385,
         ["430281807"] = 5024.901188302099,
         ["543966758"] = 5660.797812534379
      }
   },

   ["model_LMC"] = {
      ["100"] = {
         ["670828913"] = 668.252497941163,
         ["886885833"] = 670.3536346866413,
         ["715144259"] = 642.9355125576766,
         ["430281807"] = 620.335337248415,
         ["543966758"] = 618.828054018973
      },

      ["1024"] = {
         ["670828913"] = 1348.315854491724,
         ["886885833"] = 1482.762235401472,
         ["715144259"] = 1433.638544073182,
         ["430281807"] = 1450.319579711064,
         ["543966758"] = 1385.356074686716
      },

      ["10000"] = {
         ["670828913"] = 2927.1937523492143,
         ["886885833"] = 2915.0552006409994,
         ["715144259"] = 2825.1558583702727,
         ["430281807"] = 2776.830691576461,
         ["543966758"] = 2566.6459551968533
      }
   },

   ["model_bar"] = {
      ["100"] = {
         ["670828913"] = 439.1584407605331,
         ["886885833"] = 443.5701843176427,
         ["715144259"] = 440.41721569748745,
         ["430281807"] = 444.4136036992172,
         ["543966758"] = 454.66333108910976
      },

      ["1024"] = {
         ["670828913"] = 304.85275848969314,
         ["886885833"] = 291.8995713386452,
         ["715144259"] = 346.64471331794437,
         ["430281807"] = 388.43011885794556,
         ["543966758"] = 311.51893322520124
      },

      ["10000"] = {
         ["670828913"] = 180.84382054127678,
         ["886885833"] = 190.94135104423378,
         ["715144259"] = 215.76711269972805,
         ["430281807"] = 167.0633055408231,
         ["543966758"] = 269.4352862281079
      }
   },

   ["model_LMC_bar"] = {
      ["100"] = {
         ["670828913"] = 474.8738056756654,
         ["886885833"] = 484.84104437351766,
         ["715144259"] = 489.4567686605426,
         ["430281807"] = 491.0561842280801,
         ["543966758"] = 481.75679959258576
      },

      ["1024"] = {
         ["670828913"] = 681.3747526281865,
         ["886885833"] = 708.2127122666111,
         ["715144259"] = 662.0869217040214,
         ["430281807"] = 673.2205070122366,
         ["543966758"] = 684.4074635239026
      },

      ["10000"] = {
         ["670828913"] = 1852.0238723512016,
         ["886885833"] = 1804.9961296058007,
         ["715144259"] = 1854.175151742061,
         ["430281807"] = 1773.8919628452727,
         ["543966758"] = 1787.8588094359563
      }
   }
}

function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end
